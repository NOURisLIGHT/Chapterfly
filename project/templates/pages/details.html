{% extends 'base.html' %}

{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'styles/details.css' %}" />
<style>
  .fa-heart {
      font-size: 24px;
      color: #ccc;
  }
  .fa-heart .loved {
      color: red;
  }
</style>
{% endblock style %}

{% block title %}
Chapterfly - {{book.name}}
{% endblock title %}

{% block content %}
    <div class="book">
      <div class="logo"><i class="fa-solid fa-book-open icon"></i> Chapterfly</a></div>
      <h2><span id="name">{{book.name}}</span></h2>
      <p><span class="label">Price</span><span id="price">{{book.price}}</span></p>
      <p><span class="label">Author</span><span id="author">{{book.author}}</span></p>
      <p><span class="label">Category</span><span id="category">{{book.category}}</span></p>
      <p><span class="label">Availability</span><span id="available">{{book.status}}</span></p>
      <p><span class="desc" id="description">{{book.description}}</span></p>
    {% if book.status == 'available' %}
    <button type="button" class="addToCart-btn" title="Add to cart" id="add-to-cart-button" onClick="addToCart({{book.id}}, '{{book.name}}', {{book.price}}, {% if book.img %}'{{book.img.url}}'{% else %}'https://placehold.co/200x300'{% endif %}, '{{book.category}}')">
      <i class="fa-solid fa-cart-shopping"></i>
  </button>
    {% endif %}

    <form id="love-form" method="post">
      {% csrf_token %}
      <input type="hidden" name="book-id" value="{{ book.id }}">
      <input type="hidden" name="add-to-wishlist" value="true">    
      <button id="love-button">{{ 'Loved' if is_loved else 'Love' }} <i class="fa-solid fa-heart {{'loved' if is_loved else ''}}"></i></button>
    </form>

    <a href="{% url 'view' %}" class="back">Back to Books</a>
    
    <script src="{% static 'javascript/cart.js' %}"></script>
    <script >
      function getCookie(name) {
        console.log(name+" first of get cookie function");
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        console.log(name+" last of get cookie function");
        return cookieValue;
    }
    
    const loveButton = document.getElementById('love-button');
    loveButton.addEventListener('click', (event) => {
      console.log(" first of add love function");
      event.preventDefault();
      var bookId = document.querySelector('#love-form input[name="book-id"]').value;
  
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState === 4 && this.status === 200) {
            var response = JSON.parse(this.responseText);
            if (response.status === 'success') {
                loveButton.innerHTML = 'Loved <i class="fa-solid fa-heart loved"></i>';
                alert('Added to your loved books');
            } else if (response.status === 'already_in_wishlist') {
                loveButton.innerHTML = 'Loved <i class="fa-solid fa-heart loved"></i>';
                alert('This book is already in your loved books');
            }
        }
    };
      console.log(" last of add love function");
      xhttp.open("POST", "{% url 'add_love' %}", true);
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhttp.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
      xhttp.send("book-id=" + bookId);
      console.log(" end of add love function");
  })
    </script>
    </div>
{% endblock content %}
