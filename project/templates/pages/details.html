{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:type" content="website">
    <meta property="og:image" content="">
    <meta property="og:url" content="#">
    <meta property="og:description" content="Explore our online library.">
    <meta property="og:locale" content="en-US">
    <meta property="og:site_name" content="Chapterfly">
    <!-- Google fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&display=swap" rel="stylesheet"/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    
    <!-- Style sheets -->
    <link rel="stylesheet" href="{% static 'styles/mainStyle.css' %}" />
    <link rel="stylesheet" href="{% static 'styles/all.min.css' %}" />
    <link rel="stylesheet" href="{% static 'styles/details.css' %}" />
    <style>
      .fa-heart {
          font-size: 24px;
          color: #ccc;
      }
      .loved {
          color: red;
      }
      .message-container {
        display: none; /* Hidden by default */
        /* Optional shadow for depth */
    }

    .message-container .show {
        display: block; /* Show the container when needed */
    }
    </style>  
    <title>
      Chapterfly - {{book.name}}
    </title>
  </head>
  <body>

<div id="message-container" style="margin: 20px auto;
    padding: 15px;
    max-width: 600px;
    background-color: #EFFAFC;
    border: 1px solid #d1e7f1;
    border-radius: 5px;
    color: #333;
    text-align: center;
    font-size: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
    <div class="book">
      <div class="logo"><i class="fa-solid fa-book-open icon"></i> Chapterfly</a></div>
      <h2><span id="name">{{book.name}}</span></h2>
      <p><span class="label">Price</span><span id="price">{{book.price}}</span></p>
      <p><span class="label">Author</span><span id="author">{{book.author}}</span></p>
      <p><span class="label">Category</span><span id="category">{{book.category}}</span></p>
      <p><span class="label">Availability</span><span id="available">{{book.status}}</span></p>
      <p><span class="desc" id="description">{{book.description}}</span></p>
    {% if book.status == 'available' %}
      <form id="add-to-cart-form" method="post">
          {% csrf_token %}
          <button type="button" data-id="{{ book.id }}" id="add-to-cart-button" class="addToCart-btn" title="Add to cart"> 
            <i class="fa-solid fa-cart-shopping"></i>
          </button>
      </form>
    {% endif %}

    <form id="love-form" method="post">
      {% csrf_token %}
      <input type="hidden" name="book-id" value="{{ book.id }}">
      <input type="hidden" name="add-to-wishlist" value="true">    
      <button id="love-button">
        {% if is_loved %}
          Loved
        {% else %}
          Love
        {% endif %}
        <i class="fa-solid fa-heart {% if is_loved %}loved{% endif %}"></i>
      </button>
    </form>

    <a href="{% url 'view' %}" class="back" id="back-btn">Back to Books</a>
  </div>
   
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script >
      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const messageContainer = document.getElementById('message-container');

    const loveButton = document.getElementById('love-button');
    loveButton.addEventListener('click', (event) => {
      event.preventDefault();
      var bookId = document.querySelector('#love-form input[name="book-id"]').value;
  
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState === 4 && this.status === 200) {
            var response = JSON.parse(this.responseText);
            if (response.status === 'success') {
                loveButton.innerHTML = 'Loved <i class="fa-solid fa-heart loved"></i>';
                messageContainer.innerHTML = '<p>Added to your loved books</p>';
            } else if (response.status === 'already_in_wishlist') {
                loveButton.innerHTML = 'Loved <i class="fa-solid fa-heart loved"></i>';
                messageContainer.innerHTML = '<p>This book is already in your loved books</p>';
            }
        }
    };
      xhttp.open("POST", "{% url 'add_love' %}", true);
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhttp.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
      xhttp.send("book-id=" + bookId);
  })
  $(document).on('click', '#add-to-cart-button', function(e){
    e.preventDefault();

    var bookId = $(this).data('id');
    var cartURL = `/add_to_cart/${bookId}/`;
    
    $.ajax({
        type: 'POST',
        url: cartURL,
        data: {
            'book_id': bookId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response){
          messageContainer.innerHTML = `<p>${response.message}</p>`;
        },
        error: function(response){
          messageContainer.innerHTML = '<p>An error occurred. Please try again.</p>';
        }
    });
});
</script>
</body>
</html>
